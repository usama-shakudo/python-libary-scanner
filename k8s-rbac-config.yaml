---
# ServiceAccount for the scheduled job
apiVersion: v1
kind: ServiceAccount
metadata:
  name: package-scanner-scan
  namespace: hyperplane-pipelines
---
# Role with comprehensive permissions (pipelines-role-cwxtsd6t)
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: package-scanner-role
  namespace: hyperplane-pipelines
  labels:
    app.kubernetes.io/managed-by: Helm
  annotations:
    meta.helm.sh/release-name: shakudo-hyperplane
    meta.helm.sh/release-namespace: hyperplane-core
rules:
# ServiceAccount management
- apiGroups: [ "" ]
  resources: [ "serviceaccounts" ]
  verbs: [ "create", "list", "delete", "get" ]

# RBAC management
- apiGroups: [ "rbac.authorization.k8s.io" ]
  resources: [ "rolebindings", "roles" ]
  verbs: [ "create", "list", "delete", "get" ]

# Core resources
- apiGroups: [ "" ]
  resources:
  - "endpoints"
  - "events"
  - "persistentvolumeclaims"
  - "pods"
  - "pods/log"
  - "secrets"
  - "services"
  verbs: [ "get", "list", "watch", "create", "update", "delete", "patch" ]

# Apps resources
- apiGroups: [ "apps" ]
  resources:
  - "deployments"
  - "replicasets"
  verbs: [ "get", "list", "watch", "create", "update", "delete", "patch" ]

# Autoscaling
- apiGroups: [ "autoscaling" ]
  resources: [ "horizontalpodautoscalers" ]
  verbs: [ "get", "list", "watch", "create", "update", "delete", "patch" ]

# Batch jobs and cronjobs
- apiGroups: [ "batch" ]
  resources:
  - "cronjobs"
  - "jobs"
  verbs: [ "get", "list", "watch", "create", "update", "delete", "patch" ]

# Custom Resource Definitions
- apiGroups: [ "crds.hyperplane.com" ]
  resources: [ "hyperplanepodspecs" ]
  verbs: [ "get", "list", "watch", "create", "update", "delete", "patch" ]

# Extensions (legacy)
- apiGroups: [ "extensions" ]
  resources:
  - "deployments"
  - "replicasets"
  verbs: [ "get", "list", "watch", "create", "update", "delete", "patch" ]

# KEDA ScaledJobs
- apiGroups: [ "keda.sh" ]
  resources: [ "scaledjobs" ]
  verbs: [ "get", "list", "watch", "create", "update", "delete", "patch" ]

# Istio VirtualServices
- apiGroups: [ "networking.istio.io" ]
  resources: [ "virtualservices" ]
  verbs: [ "get", "list", "watch", "create", "update", "delete", "patch" ]

# Pod Disruption Budgets
- apiGroups: [ "policy" ]
  resources: [ "poddisruptionbudgets" ]
  verbs: [ "get", "list", "watch", "create", "update", "delete", "patch" ]
---
# RoleBinding to bind the role to the service account
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: package-scanner-role-binding
  namespace: hyperplane-pipelines
subjects:
- kind: ServiceAccount
  name: package-scanner-scan
  namespace: hyperplane-pipelines
roleRef:
  kind: Role
  name: package-scanner-role
  apiGroup: rbac.authorization.k8s.io
